#include "ns3/core-module.h"
#include "ns3/network-module.h"
#include "ns3/internet-module.h"
#include "ns3/point-to-point-module.h"
#include "ns3/applications-module.h"
#include "ns3/flow-monitor-module.h"
#include "ns3/olsr-helper.h"
#include "ns3/ipv4-list-routing-helper.h"
#include <iostream>
#include <iomanip>
#include <algorithm>
#include <cstdint>

using namespace ns3;


static Ptr<FlowMonitor> g_monitor;
static double g_fmInterval = 0.5;

struct Acc { int tx=0, rx=0, lost=0, rxBytes=0; double delay=0; double t=0; };
static Acc g_last;

static void ReportFM()
{
  g_monitor->CheckForLostPackets();
  const auto &stats = g_monitor->GetFlowStats();

  int tx=0, rx=0, lost=0, rxB=0; double dsum=0;
  for (const auto &kv : stats) {
    const auto &s = kv.second;
    tx   += static_cast<int>(s.txPackets);
    rx   += static_cast<int>(s.rxPackets);
    lost += static_cast<int>(s.lostPackets);
    rxB  += static_cast<int>(s.rxBytes);
    dsum += s.delaySum.GetSeconds();
  }

  double now = Simulator::Now().GetSeconds();
  double dt  = std::max(1e-9, now - g_last.t);

  int dTx  = tx   - g_last.tx;
  int dRx  = rx   - g_last.rx;
  int dLo  = lost - g_last.lost;
  int dRxB = rxB  - g_last.rxBytes;
  double dDel = dsum - g_last.delay;

  double thrMbps = (dRxB * 8.0) / (dt * 1e6);
  double lossPct = (dTx > 0) ? (100.0 * (double)dLo / (double)dTx) : 0.0;
  double avgMs   = (dRx > 0) ? (dDel / (double)dRx) * 1000.0 : 0.0;

  std::cout.setf(std::ios::fixed);
  std::cout.precision(3);
  std::cout << now << "s [FlowMonitor]\n"
            << "  Διάστημα: Tx=" << dTx << ", Rx=" << dRx
            << ", Lost=" << dLo << "  |  Loss%=" << lossPct
            << "  |  Thr=" << thrMbps << " Mbps"
            << "  |  AvgDelay=" << avgMs << " ms\n";

  g_last = {tx, rx, lost, rxB, dsum, now};
  Simulator::Schedule(Seconds(g_fmInterval), &ReportFM);
}

int main (int argc, char *argv[])
{
  //  Παράμετροι μέσω CommandLine
  std::string delay = "2ms";
  double failDownAt = 2.0;
  double failUpAt   = 3.0;

  double cbr02Start = 1.2;                 // 0->2
  double cbr03Start = 1.5;                 // 0->3
  std::string cbr02Rate = "5Mbps";
  std::string cbr03Rate = "3Mbps";
  int cbrPktSize = 512;                    // bytes

  double fmReportEvery = 0.5;              // sec

  CommandLine cmd;
  cmd.AddValue("delay", "Link delay (e.g., 1ms, 5ms, 10ms)", delay);
  cmd.AddValue("failDownAt", "Time (s) link 0-1 goes DOWN", failDownAt);
  cmd.AddValue("failUpAt",   "Time (s) link 0-1 goes UP",   failUpAt);
  cmd.AddValue("cbr02Start", "Start time (s) for CBR 0->2", cbr02Start);
  cmd.AddValue("cbr03Start", "Start time (s) for CBR 0->3", cbr03Start);
  cmd.AddValue("cbr02Rate",  "Sending rate for CBR 0->2",   cbr02Rate);
  cmd.AddValue("cbr03Rate",  "Sending rate for CBR 0->3",   cbr03Rate);
  cmd.AddValue("cbrPktSize", "Packet size for CBR apps",    cbrPktSize);
  cmd.AddValue("fmReportEvery", "Seconds between FlowMonitor reports", fmReportEvery);
  cmd.Parse(argc, argv);

  // ενημέρωση global διαστήματος
  g_fmInterval = fmReportEvery;

  // Κόμβοι & δυναμική δρομολόγηση 
  NodeContainer nodes; nodes.Create(5); // 0..4

  OlsrHelper olsr;
  Ipv4ListRoutingHelper list;
  list.Add(olsr, 10);

  InternetStackHelper stack;
  stack.SetRoutingHelper(list);  // ορισμός OLSR πριν το Install
  stack.Install(nodes);

  //  Συνδέσεις
  PointToPointHelper p2p;
  p2p.SetDeviceAttribute("DataRate", StringValue("10Mbps"));
  p2p.SetChannelAttribute("Delay",   StringValue(delay));

  NetDeviceContainer d01 = p2p.Install(NodeContainer(nodes.Get(0), nodes.Get(1)));
  NetDeviceContainer d12 = p2p.Install(NodeContainer(nodes.Get(1), nodes.Get(2)));
  NetDeviceContainer d03 = p2p.Install(NodeContainer(nodes.Get(0), nodes.Get(3)));
  NetDeviceContainer d34 = p2p.Install(NodeContainer(nodes.Get(3), nodes.Get(4)));
  NetDeviceContainer d42 = p2p.Install(NodeContainer(nodes.Get(4), nodes.Get(2)));

  // IP διευθύνσεις
  Ipv4AddressHelper address;
  address.SetBase("10.1.1.0", "255.255.255.0");
  Ipv4InterfaceContainer i01 = address.Assign(d01);
  address.SetBase("10.1.2.0", "255.255.255.0");
  Ipv4InterfaceContainer i12 = address.Assign(d12);
  address.SetBase("10.1.3.0", "255.255.255.0");
  Ipv4InterfaceContainer i03 = address.Assign(d03);
  address.SetBase("10.1.4.0", "255.255.255.0");
  Ipv4InterfaceContainer i34 = address.Assign(d34);
  address.SetBase("10.1.5.0", "255.255.255.0");
  Ipv4InterfaceContainer i42 = address.Assign(d42);

  // Sinks στους κόμβους 2 & 3 
  uint16_t portSink02 = 5000, portSink03 = 5001;

  PacketSinkHelper sinkHelper02("ns3::UdpSocketFactory",
                                InetSocketAddress(Ipv4Address::GetAny(), portSink02));
  PacketSinkHelper sinkHelper03("ns3::UdpSocketFactory",
                                InetSocketAddress(Ipv4Address::GetAny(), portSink03));
  ApplicationContainer sinkApps02 = sinkHelper02.Install(nodes.Get(2));
  ApplicationContainer sinkApps03 = sinkHelper03.Install(nodes.Get(3));
  sinkApps02.Start(Seconds(0.0)); sinkApps02.Stop(Seconds(10.0));
  sinkApps03.Start(Seconds(0.0)); sinkApps03.Stop(Seconds(10.0));

  // CBR generators (OnOff) από κόμβο 0 
  // 0 -> 2 (προς τη διεύθυνση του κόμβου 2 στη ζεύξη 1-2)
  OnOffHelper onoff02("ns3::UdpSocketFactory",
                      InetSocketAddress(i12.GetAddress(1), portSink02));
  onoff02.SetAttribute("DataRate", StringValue(cbr02Rate));
  onoff02.SetAttribute("PacketSize", UintegerValue(static_cast<uint32_t>(cbrPktSize)));
  onoff02.SetAttribute("OnTime",  StringValue("ns3::ConstantRandomVariable[Constant=1]"));
  onoff02.SetAttribute("OffTime", StringValue("ns3::ConstantRandomVariable[Constant=0]"));
  ApplicationContainer cbr02 = onoff02.Install(nodes.Get(0));
  cbr02.Start(Seconds(cbr02Start)); cbr02.Stop(Seconds(10.0));

  // 0 -> 3 (προς τη διεύθυνση του κόμβου 3 στη ζεύξη 0-3)
  OnOffHelper onoff03("ns3::UdpSocketFactory",
                      InetSocketAddress(i03.GetAddress(1), portSink03));
  onoff03.SetAttribute("DataRate", StringValue(cbr03Rate));
  onoff03.SetAttribute("PacketSize", UintegerValue(static_cast<uint32_t>(cbrPktSize)));
  onoff03.SetAttribute("OnTime",  StringValue("ns3::ConstantRandomVariable[Constant=1]"));
  onoff03.SetAttribute("OffTime", StringValue("ns3::ConstantRandomVariable[Constant=0]"));
  ApplicationContainer cbr03 = onoff03.Install(nodes.Get(0));
  cbr03.Start(Seconds(cbr03Start)); cbr03.Stop(Seconds(10.0));

  // Link failure (0–1) 
  Ptr<NetDevice> dev0 = d01.Get(0);
  Ptr<NetDevice> dev1 = d01.Get(1);
  Ptr<Ipv4> ipv4Node0 = nodes.Get(0)->GetObject<Ipv4>();
  Ptr<Ipv4> ipv4Node1 = nodes.Get(1)->GetObject<Ipv4>();
  int ifIndex0 = ipv4Node0->GetInterfaceForDevice(dev0);
  int ifIndex1 = ipv4Node1->GetInterfaceForDevice(dev1);

  if (ifIndex0 != -1 && ifIndex1 != -1) {
    Simulator::Schedule(Seconds(failDownAt), &Ipv4::SetDown, ipv4Node0, (int)ifIndex0);
    Simulator::Schedule(Seconds(failDownAt), &Ipv4::SetDown, ipv4Node1, (int)ifIndex1);

    Simulator::Schedule(Seconds(failUpAt), &Ipv4::SetUp, ipv4Node0, (int)ifIndex0);
    Simulator::Schedule(Seconds(failUpAt), &Ipv4::SetUp, ipv4Node1, (int)ifIndex1);
  } else {
    std::cerr << "ERROR: interface index not found for Node0/Node1\n";
  }

  // FlowMonitor & περιοδική αναφορά 
  FlowMonitorHelper flowmon;
  g_monitor = flowmon.InstallAll();

  // ξεκίνα λίγο μετά την πρώτη εκκίνηση CBR
  Simulator::Schedule(Seconds(std::min(cbr02Start, cbr03Start) + 0.2), &ReportFM);

  //  Run 
  Simulator::Stop(Seconds(10.0));
  Simulator::Run();

  // Τελική σύνοψη
  g_monitor->CheckForLostPackets();
  const auto &finalStats = g_monitor->GetFlowStats();
  int TX=0, RX=0, LOST=0;
  for (const auto &kv : finalStats) {
    const auto &s = kv.second;
    TX   += static_cast<int>(s.txPackets);
    RX   += static_cast<int>(s.rxPackets);
    LOST += static_cast<int>(s.lostPackets);
  }
  double totalLossPct = (TX > 0) ? (100.0 * (double)LOST / (double)TX) : 0.0;

  std::cout.setf(std::ios::fixed);
  std::cout.precision(3);
  std::cout << "==== ΤΕΛΙΚΗ ΣΥΝΟΨΗ ====\n"
            << "Συνολικά Μεταδοθέντα: " << TX << "\n"
            << "Συνολικά Ληφθέντα:    " << RX << "\n"
            << "Συνολικά Απωλεσθέντα: " << LOST << "\n"
            << "Συνολικό Loss%:       " << totalLossPct << " %\n";

  Simulator::Destroy();
  return 0;
}
